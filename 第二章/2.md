# 应用层协议

## 应用层协议的结构与分类应用

+ 应用程序体系结构包括**客户端-服务器架构**和**P2P体系结构**
+ 客户端-服务器架构
	* 发起通信的进程叫客户
	* 等待联系的进程叫服务器
	* 发送和接受报文的接口叫套接字
	* 通过IP来寻得主机，端口号区分主机上的不同应用程序

## 因特网提供的运输服务

### 因特网应用需求

![应用层协议对应的运输协议.png](./images/应用层协议对应的运输协议.png)

### TCP服务
#### 特点
1. **面向连接**：发送报文之前经过三次握手，然后建立一条**全双工**连接，发送报文，再销毁连接
2. **可靠**：非常可靠，没有字节丢失和冗余
3. **有拥塞机制**：不一定给自己带来好处，但对整个网络环境友好
4. `TCP`不安全，但有自己的加强版——`SSL`协议

### UDP服务
#### 特点
1. **轻量级**：最小化服务，最小化成本
2. 不可靠：可能发送包丢失和乱序
3. **没有拥塞机制**：可以以任何速率向网络层注入数据

### 注意
不管是`UDP`还是`TCP`，都不提供弹性带宽（吞吐量）保证和时间敏感保证。

### 对比

![TCP与UDP.png](./images/TCP与UDP.png)

### 应用层支持的运输层表

![应用层协议对应的运输协议.png](./images/应用层协议对应的运输协议.png)

## HTTP协议

### 一些web术语和基本概念、约定

+ web文档是由对象组成的。一个对象就是一个文件。对象一般由`URL`来定位。
+ URL：统一资源定位符，主要由两部分组成：一部分是主机名，另一部分是对象们的路径名，是因特网上标准的资源的地址

### HTTP概况
+ `HTTP`一般使用`TCP`作为传输层协议（但HTTP协议中并没有规定必须使用它或它支持的层）
+ `HTTP`是一个无状态协议：`HTTP`服务器不保存客户的任何信息。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快。
+ `HTTP`是一个无连接协议：限制每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。采用这种方式可以节省传输时间。
+ `HTTP`是媒体独立的：这意味着，只要客户端和服务器知道如何处理的数据内容，任何类型的数据都可以通过HTTP发送。客户端以及服务器指定使用适合的MIME-type内容类型。


### HTTP非持久连接
+ `HTTP` 0.9和1.0使用非持续连接
+ 在非持续连接下每个tcp只连接一个web对象，连接在每个请求回应对后都会关闭

### HTTP持久连接
+ `HTTP` 1.1+默认使用持续连接 1.0要加`Keep-alive`相应头
+ 一个连接可被多个请求重复利用的保持连接机制被引入，显著地减少了请求延迟，因为客户不用在首次请求后再次进行TCP交互确认创建连接
+ 优点
	* 较少的CPU和内存的使用（由于同时打开的连接的减少了）
	* 允许请求和应答的HTTP管线化
	* 降低网络阻塞 （TCP连接减少了）
	* 减少了后续请求的延迟（无需再进行握手）
	* 报告错误无需关闭TCP连接
+ 缺点
	* 对于现在的广泛普及的宽带连接来说，Keep-Alive也许并不像以前一样有用。web服务器会保持连接若干秒(Apache中默认15秒)，这与提高的性能相比也许会影响性能。
	* 对于单个文件被不断请求的服务(例如图片存放网站)，Keep-Alive可能会极大的影响性能，因为它在文件被请求之后还保持了不必要的连接很长时间。

### HTTP请求报文格式

#### 请求报文
以下是一个典型的请求报文
![http请求报文1.png](./images/http请求报文1.png)
  
可以解析为
![http请求报文2.png](./images/http请求报文2.png)

#### 请求方法
+ `GET`		请求获取Request-URI所标识的资源
+ `POST`		在Request-URI所标识的资源后附加新的数据
+ `HEAD`		请求获取由Request-URI所标识的资源的响应消息报头
+ `PUT`		请求服务器存储一个资源，并用Request-URI作为其标识
+ `DELETE`	请求服务器删除Request-URI所标识的资源
+ `TRACE`	请求服务器回送收到的请求信息，主要用于测试或诊断
+ `CONNECT`	保留将来使用
+ `OPTIONS`	请求查询服务器的性能，或者查询与资源相关的选项和需求

#### 请求URL
+ 统一资源定位符的标准格式如下：  
协议类型://服务器地址（必要时需加上端口号）/路径/文件名  

+ 而`HTTP`的统一资源定位符将从因特网获取信息的五个基本元素包括在一个简单的地址中：
1. 传送协议(http/https)。
2. 服务器。（通常为域名，有时为IP地址）
3. 端口号。（以数字方式表示，若为HTTP的预设值“:80”可省略）
4. 路径。（以“/”字元区别路径中的每一个目录名称）
5. 查询字符串(query string)。（GET模式的表单参数，以“?”字元为起点，每个参数以“&”隔开，再以“=”分开参数名称与资料，通常以UTF8的URL编码，避开字元冲突的问题）

#### 其他字段
+ Accept：浏览器可接受的MIME类型。
+ Accept-Charset：浏览器可接受的字符集。
+ Accept-Encoding：浏览器能够进行解码的数据编码方式，比如`gzip`。`Servlet`能够向支持`gzip`的浏览器返回经gzip编码的HTML页面。许多情形下这可以减少5到10倍的下载时间。
+ Accept-Language：浏览器所希望的语言种类，当服务器能够提供一种以上的语言版本时要用到。
+ Authorization：授权信息，通常出现在对服务器发送的WWW-Authenticate头的应答中。
+ Connection：表示是否需要持久连接。HTTP1.1默认是`keep-alive`
+ Content-Length：表示请求消息正文的长度。
+ Cookie：这是最重要的请求头信息之一
+ From：请求发送者的email地址，由一些特殊的Web客户程序使用，浏览器不会用到它。
+ Host：初始URL中的主机和端口。
+ If-Modified-Since：只有当所请求的内容在指定的日期之后又经过修改才返回它，否则返回304“Not Modified”应答。
+ Pragma：指定“no-cache”值表示服务器必须返回一个刷新后的文档，即使它是代理服务器而且已经有了页面的本地拷贝。
+ Referer：包含一个URL，用户从该URL代表的页面出发访问当前请求的页面。
+ User-Agent：浏览器类型，如果Servlet返回的内容与浏览器类型有关则该值非常有用。

### HTTP响应报文形式

#### 应答报文
HTTP响应由三个部分组成，分别是：状态行、消息报头、响应正文。以下是响应报文的基本形式：
![http响应.jpg](./images/http响应.jpg)

#### 状态行
状态行格式如下：
HTTP-Version Status-Code Reason-Phrase CRLF
其中：  

+ HTTP-Version表示服务器HTTP协议的版本；
+ Status-Code表示服务器发回的响应状态代码；
+ Reason-Phrase表示状态代码的文本描述。
+ CRLF是换行

#### 响应码
状态代码有三位数字组成，第一个数字定义了响应的类别，且有五种可能取值：

+ 1xx：指示信息--表示请求已接收，继续处理
	* 100 Continue 客户端应当继续发送请求的剩余部分。服务器必须在请求完成后向客户端发送一个最终响应。
	* 101 Switching Protocols 服务器已经理解请求，并将通过Upgrade消息头通知客户端采用不同的协议来完成这个请求。在发送完这个响应最后的空行后，服务器将会切换到在Upgrade消息头中定义的那些协议。
+ 2xx：成功--表示请求已被成功接收、理解、接受
	* 204 No Content 服务器成功处理了请求，但不需要返回任何实体内容，并且希望返回更新了的元信息。响应可能通过实体头部的形式，返回新的或更新后的元信息。
	* 206 Partial Content 服务器已经成功处理了部分GET请求。类似于FlashGet或者迅雷这类的HTTP 下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。该请求必须包含Range头信息来指示客户端希望得到的内容范围，并且可能包含If-Range来作为请求条件。
+ 3xx：重定向--要完成请求必须进行更进一步的操作
	* 300 Multiple Choices 被请求的资源有一系列可供选择的回馈信息，用户或浏览器能够自行选择一个首选的地址进行重定向。
	* 301 Moved Permanently 被请求的资源已永久移动到新位置，将来任何对此资源的引用都应使用本响应返回的若干个URI之一。
+ 4xx：客户端错误--请求有语法错误或请求无法实现
	* 400 Bad Request 由于包含语法错误，当前请求无法被服务器理解。除非进行修改，否则客户端不应该重复提交这个请求。
	* 401 Unauthorized 当前请求需要用户验证。该响应必须包含一个WWW-Authenticate信息头用以询问用户信息。
	* 403 Forbidden 服务器已经理解请求，但是拒绝执行它。
	* 404 Not Found 请求失败，请求所希望得到的资源未被在服务器上发现。
	* 407 Proxy Authentication Required 与401响应类似，只不过客户端必须在代理服务器上进行身份验证。
	* 410 Gone 被请求的资源在服务器上已经不再可用，而且没有任何已知的转发地址。这样的状况应当被认为是永久性的。
	* 421 There are too many connections from your internet address 从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围
	* 426 Upgrade Required 客户端应当切换到TLS/1.0。
+ 5xx：服务器端错误--服务器未能实现合法的请求
	* 500 Internal Server Error 服务器遇到状况，无法完成对请求的处理。一般来说，这个问题都会在服务器的程序码出错时出现。
	* 501 Not Implemented 服务器无法识别请求的方法，并且无法支持其对任何资源的请求。
	* 502 Bad Gateway 作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应。
	* 503 Service Unavailable 由于临时的服务器维护或者过载，服务器当前无法处理请求。
	* 504 Gateway Timeout 作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。注意：某些代理服务器在DNS查询超时时会返回400或者500错误。

#### 消息报头
+ Location 响应报头域用于重定向接受者到一个新的位置。Location响应报头域常用在更换域名的时候。
+ Server响应报头域包含了服务器用来处理请求的软件信息。与User-Agent请求报头域是相对应的。
+ WWW-Authenticate 必须被包含在401（未授权的）响应消息中，客户端收到401响应消息时候，并发送Authorization报头域请求服务器对其进行验证时，服务端响应报头就包含该报头域。
+ Content-Encoding 它的值指示了已经被应用到实体正文的附加内容的编码，因而要获得Content-Type报头域中所引用的媒体类型，必须采用相应的解码机制。Content-Encoding这样用于记录文档的压缩方法，eg：Content-Encoding：gzip
+ Content-Language 实体报头域描述了资源所用的自然语言。没有设置该域则认为实体内容将提供给所有的语言阅读
者。
+ Content-Length 实体报头域用于指明实体正文的长度，以字节方式存储的十进制数字来表示。
+ Content-Type实体报头域用语指明发送给接收者的实体正文的媒体类型。
+ Last-Modified实体报头域用于指示资源的最后修改日期和时间。
+ Expires实体报头域给出响应过期的日期和时间。

## FTP协议

### 一些术语和基本概念、约定
+ 文件传输协议（缩写：FTP）是用于在网络上进行文件传输的一套标准协议。它属于网络传输协议的应用层。

### FTP概况
+ FTP是一个8位的客户端-服务器协议，能操作任何类型的文件而不需要进一步处理，就像MIME或Unicode一样。
+ FTP有着极高的延时，这意味着，从开始请求到第一次接收需求数据之间的时间，会非常长；并且不时的必须执行一些冗长的登陆进程。
+ FTP服务一般运行在20和21两个端口。端口20用于在客户端和服务器之间传输数据流，而端口21用于传输控制流，并且是命令通向ftp服务器的进口。
+ 当数据通过数据流传输时，控制流处于空闲状态。而当控制流空闲很长时间后，客户端的防火墙会将其会话置为超时，这样当大量数据通过防火墙时，会产生一些问题。此虽然文件可以成功的传输，但因为控制会话会被防火墙断开；传输会产生一些错误。
+ 运行FTP服务的许多站点都开放匿名服务，匿名用户的用户名是：“anonymous”。这个帐号不需要密码。
+ FTP是个有状态连接 必须追踪用户所在的文件树

### FTP缺点
+ 密码和文件内容都使用明文传输，可能发生窃听。
+ 因为必须开放一个随机的端口以创建连接，当防火墙存在时，客户端很难过滤处于主动模式下的FTP流量。这个问题，通过使用被动模式的FTP，得到了很大解决。
+ 服务器可能会被告知连接一个第三方计算机的保留端口。
+ 此方式在需要传输文件数量很多的小文件时，性能不好。

### 主动和被动模式
FTP有两种使用模式：主动和被动。主动模式要求客户端和服务器端同时打开并且监听一个端口以创建连接。在这种情况下，客户端由于安装了防火墙会产生一些问题。所以，创立了被动模式。被动模式只要求服务器端产生一个监听相应端口的进程，这样就可以绕过客户端安装了防火墙的问题。  

一个主动模式的FTP连接创建要遵循以下步骤：

1. 客户端打开一个随机的端口（端口号大于1024，在这里，我们称它为x），同时一个FTP进程连接至服务器的21号命令端口。此时，该tcp连接的来源地端口为客户端指定的随机端口x，目的地端口（远程端口）为服务器上的21号端口。
2. 客户端开始监听端口（x+1），同时向服务器发送一个端口命令（通过服务器的21号命令端口），此命令告诉服务器客户端正在监听的端口号并且已准备好从此端口接收数据。这个端口就是我们所知的数据端口。
3. 服务器打开20号源端口并且创建和客户端数据端口的连接。此时，来源地的端口为20，远程数据(目的地)端口为（x+1）。
4. 客户端通过本地的数据端口创建一个和服务器20号端口的连接，然后向服务器发送一个应答，告诉服务器它已经创建好了一个连接。

## SMTP协议
