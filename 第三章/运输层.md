[TOC]

# 运输层协议

## 概述与约定

### 概述

+ 运输层协议为不同主机上的进程提供了**逻辑通信**功能
+ 运输层协议在端系统（主机）里实现 而不是路由器
+ 运输层中的分组(包)称之为**报文段**
+ 常见的运输层协议有TCP和UDP

### 运输层和网络层的关系

+ 拿送信做比方
  + 应用层报文 = 信封上的字符
  + 进程 = 发件人和收件人
  + 主机 = 发件人的家庭 收件人的家庭
  + 运输层协议 = 邮递员
  + 网络层协议 = 邮政服务

### 因特网中的运输层

#### 预备知识---IP协议

+ IP协议是一个网络层协议
+ IP的服务模型是“尽力而为”，但并不保证服务，是不可靠的
+ 每台主机有一个IP地址

#### TCP和UDP的责任

共有的：

+ **多路分解和多路复用** ：将主机间的交互转化为进程间的交互
+ **差错检查** ：通过报文段首部加入差错检查字段

TCP独有：

+ **可靠传输** ： 通过流量控制、序号、确认、定时器
+ **拥塞机制** ： 调节流量

## 多路复用机制

### 概述

+ 一个进程有一个或者多个套接字
+ 运输层实际上将数据交给了套接字们
+ 每个套接字都有唯一的标识符 并且标志了它是UDP还是TCP
+ 多路分解操作：在接收端，运输层协议检查报文头，读取接收套接字的信息，然后定向连接
+ 多路复用操作：在发送端，运输层协议从不同套接字收集信息，生成头部信息并打包

### 无连接的多路复用和多路分解

+ 运输层的报文包含应用程序数据、源端口号、目的端口号和其他两个值
+ 端口号是套接字的标志 一个UDP套接字由一个二元组构成，包含
  + 目的IP地址
  + 目的端口号
+ 只要目的IP和端口号一致，UDP报文就会被送到同一个套接字

### 面向连接的多路复用和多路分解

+ TCP套接字是一个四元组，包含：
  + 源IP
  + 源端口号
  + 目的IP
  + 目的端口号
+ 主机用套接字的全部四个值来分解，也就是说就算目的相同，源不同也不会分配到同个套接字，除非TCP报文段提供了初始连接的请求
+ 只有四个值都互相匹配，双方套接字才能互相发消息

### Web服务器和TCP

+ Web服务的默认端口是80
+ 对于持续HTTP，持续期间使用同一对套接字
+ 对于非持续HTTP，每一对请求/响应都创建一对套接字，再销毁
+ 套接字和进程不一定一一对应，因为有线程的存在

## UDP协议：无连接运输

### 概述

+ UDP无非只是给网络层协议加上了一点多路复用/分解服务而已
+ web应用选择UDP服务，几乎无异于直接和IP打交道
+ UDP没有握手过程，是无连接的
+ DNS是使用UDP服务的典型范例，如果没有收到响应，则会向另一DNS服务器发请求，直到发现怎么都没有响应

### 优点

+ 关于何时、发送什么数据的应用层控制更加精细
+ 无需建立连接（握手）
+ 无连接：不需要在主机中维护连接状态
+ 分组首部仅仅8字节，而TCP需要20字节

### 应用层协议对应的运输层协议 ![应用层协议对应的运输协议](/home/hongjiyao_2014150120/Computer Netwoking/第二章/images/应用层协议对应的运输协议.png)

### 对比 ![TCP与UDP](/home/hongjiyao_2014150120/Computer Netwoking/第二章/images/TCP与UDP.png)

### UDP报文段结构

UDP报文的结构是32比特的头部，加上应用层报文

32比特平均分成4部分，包括源端口号，目的端口号，数据长度(首部+应用数据)，校验和

### UDP校验和

+ UDP校验和提供了**差错检测**功能，能检查链路层是否发生了比特改变
+ 发送方的UDP对报文段中所有16比特的字全部相加，再进行反码运算(溢出时回滚)
+ 虽然链路层也提供差错检测，但是不能保证所有链路都有提供
+ 虽然UDP有差错检测，但是它**没有任何纠错和恢复能力**，只能丢弃受损的报文，或者发出警告

## 可靠数据传输原理

### 可靠传输图解![可靠数据运输机制](/home/hongjiyao_2014150120/Computer Netwoking/第二章/images/可靠数据运输机制.png)

